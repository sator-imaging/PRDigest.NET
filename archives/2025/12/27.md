### 目次 {#table-of-contents}
1. [#122753 Fix debug build](#122753)
2. [#122571 Refactor lock upgrade logic](#122571)
3. [#122466 Resolve dllimport.cpp runtimeasync todos](#122466)

---
### [#122753](https://github.com/dotnet/runtime/pull/122753) Fix debug build {#122753}
- 作成者: [@am11](https://github.com/am11)
- 作成日時: 2025年12月27日 12:52:41(UTC)
- マージ日時: 2025年12月27日 16:18:03(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-System.Threading</span> <span style="background-color: #c2e0c6; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">community-contribution</span>
#### 概要
`System.Threading.Interlocked.CoreCLR.cs`ファイルにおいて、IDE0036ルール（修飾子の順序）の違反を修正するコード整理です。デバッグビルドで発生していたコンパイルエラーを解消するための軽微な変更となります。

#### 変更内容
- **ファイル**: `src/coreclr/System.Private.CoreLib/src/System/Threading/Interlocked.CoreCLR.cs`
- **変更**: 149行目の修飾子順序を修正（+1/-1）
- **詳細**: メンバーの修飾子（public、private、static、asyncなど）の並び順をC#のコーディング標準に準拠するよう調整

#### パフォーマンスへの影響
影響なし

#### 関連Issue
なし

#### その他
- このPRは純粋なコード品質改善であり、機能変更を含みません
- IDE0036ルールはコーディング規約の一貫性を確保するため、Microsoft公式ガイドラインで推奨されています
- area-owners.md登録者（@mangod9）への自動通知が実施されています

---
### [#122571](https://github.com/dotnet/runtime/pull/122571) Refactor lock upgrade logic {#122571}
- 作成者: [@jkoritzinsky](https://github.com/jkoritzinsky)
- 作成日時: 2025年12月16日 00:23:24(UTC)
- マージ日時: 2025年12月27日 01:37:17(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-VM-coreclr</span>
#### 概要
ロック アップグレード ロジックのリファクタリングにより、GCホール関連の問題（#122275、#122482）を修正するPR。ARM32プラットフォームで、マネージコードから`Interlocked.CompareExchange`呼び出し時に形成されたrefがJITにより不正なヒープポインタとして報告され、クラッシュが発生していた問題に対処。NativeAOTで実装されているポインタオーバーロード版の`CompareExchange`をCoreCLRに導入することで解決。

#### 変更内容
- **Interlocked.CoreCLR.cs**：ポインタを直接操作する新しい`CompareExchange`オーバーロードを追加（ARM32向けmust-expand対応）
- **ObjectHeader.CoreCLR.cs**：ロック関連ロジックの微調整
- **Interlocked.cs (NativeAOT)**：既存実装の最適化
- **syncblk.cpp/syncblk.h/syncblk.inl**：ネイティブ側のロックアップグレードロジック更新

#### パフォーマンスへの影響
ほぼ影響なし。ローカル開発マシンでのベンチマーク結果：
- PR版：37.33μs
- main版：36.97μs
- 差異：約1%で統計的な有意差なし

従来のマネージド実装よりはネイティブコードでのポインタ直接操作の方がパフォーマンスが優れているが、インライン化による最適化と相殺される。

#### 関連Issue
- #122275
- #122482

#### その他
重要な調査結果：JITが完全形成されたref（オブジェクトヘッダアドレス）をスタックフレームに報告しており、これが無効なヒープポインタアクセスの原因。ARM32では`CompareExchange`がmust-expandでないため、この問題が顕在化。他プラットフォームではインライン展開時に最適化される。

---
### [#122466](https://github.com/dotnet/runtime/pull/122466) Resolve dllimport.cpp runtimeasync todos {#122466}
- 作成者: [@jkoritzinsky](https://github.com/jkoritzinsky)
- 作成日時: 2025年12月11日 21:16:00(UTC)
- マージ日時: 2025年12月27日 02:16:15(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-Interop-coreclr</span> <span style="background-color: #2D0DA0; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">runtime-async</span>
#### 概要
P/Invoke メソッドとデリゲートの `Invoke` メソッドに async ビットが設定される不正なシナリオへの対応。Roslyn は意図的にこれらのメソッドに async を付与しないため、不正な状態を検出・拒否する実装を追加。Task/ValueTask を戻り値とする P/Invoke 定義などが対象。

#### 変更内容
- **dllimport.cpp**: async ビットを検出してアサート失敗に
- **methodtablebuilder.cpp**: P/Invoke メソッドに async ビットがある場合にエラー処理を追加
- **comdelegate.cpp**: デリゲートの Invoke メソッドの async ビット検出
- **CorInfoImpl.cs, NativeAotILProvider.cs**: AOT コンパイラでの同様のチェック追加
- **UnmanagedCallingConventions.cs**: UnmanagedCallersOnly メソッドの async ビット検出時に InvalidProgramException を発生
- **リソース**: エラーメッセージの追加（mscorrc.rc, Strings.resx）
- **テスト**: RuntimeAsync および UnmanagedCallersOnly の検証テストを拡充

#### パフォーマンスへの影響
影響なし。この変更は不正な状態の早期検出であり、正常な P/Invoke メソッドのパフォーマンスには影響しません。

#### 関連Issue
#121758, #122466

#### その他
コメント欄で指摘されている通り、Task 戻り値の P/Invoke 定義（例：`extern Task QueryPerformanceFrequency()`）は現在のテスト対象となっており、この不正なシナリオをランタイムが確実に拒否するようになります。`MethodImplOptions.Synchronized` と同様に `MethodImplOptions.Async` も型ロード時に TypeLoadException をスローする実装が求められています。

---
