### 目次 {#table-of-contents}
1. [#122794 Rename AsyncSafeThreadMap to SignalSafeThreadMap](#122794)
2. [#122791 Consolidate runtime helpers (X86Base, Interlocked, Buffer) across CoreCLR and NativeAOT](#122791)
3. [#122688 Split GetInterpThreadContext into allocating and non-allocating variants](#122688)
4. [#122589 [RISC-V] Comment and formatting cleanup in `codegenriscv64`](#122589)
5. [#121745 Move RBM_SAVED_LOCALLOC_SP reservation from compCompile to setFrameType in LSRA](#121745)
6. [#121158 Refactor NativeAOT helpers to align with CoreCLR patterns](#121158)

---
### [#122794](https://github.com/dotnet/runtime/pull/122794) Rename AsyncSafeThreadMap to SignalSafeThreadMap {#122794}
- 作成者: [@Copilot](https://github.com/apps/copilot-swe-agent)
- 作成日時: 2025年12月31日 04:48:12(UTC)
- マージ日時: 2026年01月02日 14:08:13(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-VM-coreclr</span>
#### 概要
`AsyncSafeThreadMap`クラスを`SignalSafeThreadMap`にリネームするリファクタリング。.NETの`async/await`パターンとの混同を避けるため、シグナルハンドラー内での安全な使用を目的とした本クラスの実際の用途に合わせた命名に統一しました。命名の一貫性向上により、コード意図の明確化を実現します。

#### 変更内容
- **SignalSafeThreadMap.cpp** (+11/-11): クラス名およびそれに関連する参照を`AsyncSafeThreadMap`から`SignalSafeThreadMap`に変更
- **SignalSafeThreadMap.h** (+9/-9): ヘッダーファイル内のクラス定義およびコメント内の名前を更新
- **threadstore.cpp** (+5/-5): NativeAoT ランタイムの実装内での使用箇所を更新
- **threads.cpp** (+5/-5): VM層のスレッド管理コード内での参照を更新
- **CMakeLists.txt** (複数): ビルド設定ファイルのターゲット名を更新（CMakeLists.txtで2箇所、vm/CMakeLists.txtで2箇所）

#### パフォーマンスへの影響
影響なし。純粋なリネーミング変更のため、実行時の動作やパフォーマンス特性に変更はありません。

#### 関連Issue
なし

#### その他
このリネーミングにより、シグナルハンドラー内での安全な実装であることが命名から直感的に理解でき、開発者にとってコード可読性が向上します。async/awaitとの概念的な混同を回避し、マルチスレッド処理における安全性の意図がより明確に表現されました。

---
### [#122791](https://github.com/dotnet/runtime/pull/122791) Consolidate runtime helpers (X86Base, Interlocked, Buffer) across CoreCLR and NativeAOT {#122791}
- 作成者: [@Copilot](https://github.com/apps/copilot-swe-agent)
- 作成日時: 2025年12月31日 03:38:52(UTC)
- マージ日時: 2026年01月02日 14:57:25(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-NativeAOT-coreclr</span>
#### 概要
CoreCLR、NativeAOT、Monoの3つのランタイム間で重複するネイティブヘルパー実装（X86Base、Interlocked、Buffer）を統合し、共有コードを最大化するリファクタリング。新しい共有実装を`src/coreclr/runtime/MiscNativeHelpers.cpp/h`に集約し、すべてのランタイムが同一のマネージドコードファイルを使用するよう統一しました。プラットフォーム固有の部分クラス（`*.CoreCLR.cs`、`*.NativeAot.cs`、`*.Mono.cs`）をすべて削除。

#### 変更内容

**主な追加・削除ファイル：**
- 追加：`src/coreclr/runtime/MiscNativeHelpers.cpp/h`（共有QCall実装）
- 追加：`src/coreclr/nativeaot/Runtime/common.h`（QCALLTYPE定義）
- 削除：すべてのランタイム固有の部分クラス（X86Base.CoreCLR.cs、X86Base.NativeAot.cs、X86Base.Mono.cs、Buffer.CoreCLR.cs、Buffer.NativeAot.cs等）
- 削除：`Range.h`、不要な`AllocHeap::Contains`メソッド

**実装の統合：**
1. **X86Base_CpuId**：CPUID命令のラッパーをQCall化。Monoのネイティブ実装もメソッド名を`__cpuidex`から`CpuId`に統一
2. **Interlocked_MemoryBarrierProcessWide**：プロセス全体のメモリバリア実装を共有化
3. **Buffer操作**：`Buffer_Clear`と`Buffer_MemMove`をQCallから削除し、`SpanHelpers.ByteMemOps.cs`で直接`memset`/`memmove`を呼び出すよう変更

**マネージドコード統合：**
```csharp
// 共有実装例（#if MONO条件付き）
#if MONO
[DllImport("__Internal", EntryPoint = "ves_icall_System_SpanHelpers_memmove")]
private static extern void memmove(void* dest, void* src, nuint len);
#else
[LibraryImport("QCall", EntryPoint = "SpanHelpers_MemMove")]
private static extern void memmove(void* dest, void* src, nuint len);
#endif
```

**インフラ整備：**
- CMakeLists.txtを両方のランタイムで更新し共有ファイルをインクルード
- メモリアライメント最適化：`Unsafe.WriteUnaligned`と`Block16`を使用
- 型安全性強化：`size_t`から`int`/`uint32_t`への明示的キャスト追加
- Mono icall定義の整列：`System.SpanHelpers`をアルファベット順の正しい位置に移動

#### パフォーマンスへの影響

**改善点：**
- BufferのMemMoveはQCallオーバーヘッドを削除し、直接`memmove`呼び出しに変更してパフォーマンス向上
- メモリゼロ操作を`Unsafe.WriteUnaligned`で最適化し、より良いコード生成を実現
- `THUNKS_MAP_SIZE`マクロをローカル変数にキャッシュして冗長な評価を防止

**懸念点：** 影響なし。同じプラットフォームAPI（minipal/CRT）を

---
### [#122688](https://github.com/dotnet/runtime/pull/122688) Split GetInterpThreadContext into allocating and non-allocating variants {#122688}
- 作成者: [@jkotas](https://github.com/jkotas)
- 作成日時: 2025年12月21日 16:05:03(UTC)
- マージ日時: 2026年01月02日 14:03:55(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-CodeGen-Interpreter-coreclr</span>
#### 概要
GetInterpThreadContextを割り当て型と非割り当て型の2つのバリアントに分割し、インタープリタが実際に使用される場合のみInterpThreadContextを確保するように改善したPull Requestです。従来はTryEnsureSufficientExecutionStackなどの処理でインタープリタを使用していない場合でも不要なメモリ割り当てが発生していました。

#### 変更内容
- **threads.cpp/threads.h**: GetInterpThreadContextを2つの関数に分割（割り当て版と非割り当て版）、約22行の追加と12行の削除
- **interpexec.cpp**: インタープリタ実行時の呼び出し調整、3行追加7行削除
- **prestub.cpp**: プリスタブ処理の最適化、1行追加8行削除
- **eetwain.cpp**: 4行削除による不要な呼び出しの除去

#### パフォーマンスへの影響
**改善**: インタープリタを使用していないシナリオ（例：TryEnsureSufficientExecutionStack）で不要なメモリ割り当てが削除され、メモリ効率が向上します。特にスレッド作成やコンテキスト処理が多い場合に効果的です。

#### 関連Issue
https://github.com/dotnet/runtime/issues/122404

#### その他
このPRはインタープリタコンテキスト管理の最適化に関連するもので、.NET Runtimeのメモリ管理効率向上を目指しています。VM層での細かいメモリ割り当て削減により、全体的なシステムリソース効率が改善されます。

---
### [#122589](https://github.com/dotnet/runtime/pull/122589) [RISC-V] Comment and formatting cleanup in `codegenriscv64` {#122589}
- 作成者: [@credo-quia-absurdum](https://github.com/credo-quia-absurdum)
- 作成日時: 2025年12月16日 13:00:58(UTC)
- マージ日時: 2026年01月02日 09:57:40(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-CodeGen-coreclr</span> <span style="background-color: #c2e0c6; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">community-contribution</span> <span style="background-color: #eb6420; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">arch-riscv</span>
#### 概要
RISC-V 64ビット向けコード生成部分（`codegenriscv64.cpp`）のコメントと書式をクリーンアップするマイナー更新です。機能的な変更は含まれておらず、コードの可読性と保守性の向上を目的としています。

#### 変更内容
- **ファイル**: `src/coreclr/jit/codegenriscv64.cpp`
  - コメントの追加・改善（関数ヘッダーコメントの整備）
  - 英文表現の明確化と可読性向上
  - 書式とスタイルの軽微な修正
  - 変更行数: +39/-12（合計51行）

#### パフォーマンスへの影響
影響なし。本PR は機能変更を含まないため、実行時のパフォーマンスに影響を与えません。

#### 関連Issue
#84834（Samsung チーム関連のクリーンアップイシュー）

#### その他
- Samsung チーム主導のコード品質改善プロジェクトの一部です
- レビュワーに JIT コンパイラ関連の専門家が含まれており、品質管理が適切に行われています
- RISC-V バックエンド対応の継続的な改善活動の一環です

---
### [#121745](https://github.com/dotnet/runtime/pull/121745) Move RBM_SAVED_LOCALLOC_SP reservation from compCompile to setFrameType in LSRA {#121745}
- 作成者: [@Copilot](https://github.com/apps/copilot-swe-agent)
- 作成日時: 2025年11月18日 14:31:43(UTC)
- マージ日時: 2026年01月02日 10:52:17(UTC)
- ラベル: <span style="background-color: #d4c5f9; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">area-CodeGen-coreclr</span>
#### 概要
ARM向けのレジスタ予約ロジック（`RBM_SAVED_LOCALLOC_SP`）をコンパイラの`compCompile`関数から、LSRA（Linear Scan Register Allocator）の`setFrameType`関数へ移動するリファクタリング。コード機能の変更なし。

#### 変更内容
- **src/coreclr/jit/compiler.cpp**: `compCompile`関数内のARM向け条件付きコンパイルブロックを削除（8行削除）
- **src/coreclr/jit/lsra.cpp**: `setFrameType`関数内に同じロジックを追加し、既存の`rsMaskResvd`設定の後に配置（10行追加）
- デバッグ出力用のJITDUMP文を追加して、レジスタ予約時にログを出力

#### パフォーマンスへの影響
影響なし。既存の機能を別の場所に移動しただけで、動作や処理時間は変わらない。

#### 関連Issue
なし

#### その他
- CoreCLRビルド成功確認済み
- CodeQL セキュリティスキャン実施済み（脆弱性なし）
- コード移動により、関連する`rsMaskResvd`設定処理が一箇所に集約され、保守性が向上

---
### [#121158](https://github.com/dotnet/runtime/pull/121158) Refactor NativeAOT helpers to align with CoreCLR patterns {#121158}
- 作成者: [@Copilot](https://github.com/apps/copilot-swe-agent)
- 作成日時: 2025年10月29日 03:15:58(UTC)
- マージ日時: 2026年01月02日 14:48:51(UTC)
- ラベル: <span style="background-color: #A8F937; color: #000000; display: inline-block; padding: 0 7px; font-size:12px; font-weight:500; line-height:18px; border-radius:2em; border:1px solid transparent; white-space:nowrap; cursor:default;">needs-area-label</span>
#### 概要
NativeAOT（ネイティブAOT）のヘルパーメソッドをCoreClrのパターンに合わせてリファクタリングするPR。`ArrayHelpers.cs`と`TypedReferenceHelpers.cs`から適切なターゲット型にメソッドを移動し、NativeAOTと非NativeAOTの構造をより類似させることが目的。これにより、コード保守性が向上し、プラットフォーム間の一貫性が改善される。

#### 変更内容
- **ArrayHelpers.cs削除**: `src/coreclr/nativeaot/System.Private.CoreLib/src/Internal/Runtime/CompilerHelpers/ArrayHelpers.cs`を削除（98行削減）
- **TypedReferenceHelpers.cs削除**: `src/coreclr/nativeaot/System.Private.CoreLib/src/Internal/Runtime/CompilerHelpers/TypedReferenceHelpers.cs`を削除（35行削減）
- **Array.NativeAot.cs拡張**: ヘルパーメソッドをこのファイルに統合（186行に拡張）
- **TypedReference.cs更新**: TypedReferenceのヘルパー機能を統合（20行に拡張）
- **SharedCodeHelpers.cs追加**: 共有ヘルパー機能を新規追加（10行）
- **jithelpers.h更新**: `METHOD__ARRAY__CREATEINSTANCEMDARRAY`を`METHOD__ARRAY__CTORANY`に変更
- **プロジェクトファイル更新**: csprojから削除されたファイルのリファレンスを削除

#### パフォーマンスへの影響
影響なし。このリファクタリングは構造の統一を目的としたもので、実行時動作への変更はない。メソッドの移動により若干のコンパイル効率向上が期待される。

#### 関連Issue
なし

#### その他
- 複数のビルドエラーを段階的に修正しており、最終的には全ての依存関係が正しく解決されている
- `using System;`と`using Internal.Runtime.Augments;`ディレクティブの追加が必要だった
- CopilotがAIアシスタントとして自動修正を繰り返し行い、jkotasがレビューを担当した
- ドラフト状態で30日間のInactivityにより自動的にクローズされていたが、再度アクティベートされている

---
